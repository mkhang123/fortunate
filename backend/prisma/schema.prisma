generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

// --- NGƯỜI DÙNG ---
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  name          String?
  phone         String?   
  avatar        String?
  isActive      Boolean   @default(true)
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses     Address[]
  cart          Cart?
  orders        Order[]
  reviews       Review[]
  wishlist      Wishlist[]
  bodyProfile   UserBodyProfile?
  tryOns        VirtualTryOnSession[]
  notifications Notification[]

  @@index([email])
}

enum Role {
  USER
  ADMIN
  CREATOR
}

model Address {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userName  String
  phone     String
  address   String
  city      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isDefault])
}

// --- QUẢN LÝ SẢN PHẨM ---
model Brand {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  slug        String    @unique
  logo        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Category {
  id           Int        @id @default(autoincrement())
  name         String
  slug         String     @unique
  image        String?
  isActive     Boolean    @default(true)
  displayOrder Int        @default(0)
  parentId     Int?
  parent       Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     Category[] @relation("CategoryHierarchy")
  products     Product[]

  @@index([slug])
}

model Product {
  id          Int           @id @default(autoincrement())
  name        String
  slug        String        @unique
  price       Float?        // GIÁ THAM KHẢO (Dùng để hiển thị ở trang danh sách)
  status      ProductStatus @default(DRAFT)
  images      String[]      // MẢNG URL ẢNH (Tối ưu hóa bảng)
  
  brandId     Int?
  brand       Brand?        @relation(fields: [brandId], references: [id], onDelete: SetNull)
  categoryId  Int
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  variants  ProductVariant[]
  reviews   Review[]
  wishlists Wishlist[]

  @@index([categoryId, status])
  @@index([brandId])
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  OUT_OF_STOCK
  ARCHIVED
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  color          String
  size           String
  price          Float   // GIÁ THỰC TẾ (Dùng để tính tiền trong giỏ hàng)
  stock          Int     @default(0)

  measurement ProductMeasurement?
  cartItems   CartItem[]
  orderItems  OrderItem[]
  tryOns      VirtualTryOnSession[]

  @@unique([productId, color, size])
  @@index([productId])
}

// --- GIỎ HÀNG & ĐƠN HÀNG ---

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        Int            @id @default(autoincrement())
  cartId    Int
  variantId Int
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  quantity  Int
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([cartId, variantId])
}

model Order {
  id                  Int         @id @default(autoincrement())
  userId              Int
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  status              OrderStatus @default(PENDING)
  
  // SNAPSHOT THÔNG TIN KHÁCH HÀNG TẠI THỜI ĐIỂM ĐẶT
  receiverName        String?     
  receiverPhone       String?
  receiverEmail       String?     // Thêm Email để gửi hóa đơn & VNPay
  shippingAddress     String
  
  trackingNumber      String?
  notes               String?
  total               Float
  
  cancelledAt         DateTime?
  shippedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime    @default(now())

  items               OrderItem[]
  payment             Payment?

  @@index([userId, status])
  @@index([createdAt])
}

model OrderItem {
  id        Int            @id @default(autoincrement())
  orderId   Int
  variantId Int
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  price     Float          // Snapshot giá lúc mua
  quantity  Int
}

model Payment {
  id                Int           @id @default(autoincrement())
  orderId           Int           @unique
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method            PaymentMethod @default(VNPAY)
  status            PaymentStatus @default(PENDING)
  
  vnp_TransactionNo String?
  vnp_ResponseCode  String?
  vnp_OrderInfo     String?
  
  paidAt            DateTime?
  amount            Float
  metadata          Json?

  @@index([status])
}

// --- TƯƠNG TÁC ---
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String?  
  link      String?  
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

model Banner {
  id          Int      @id @default(autoincrement())
  title       String?
  imageUrl    String
  linkUrl     String?
  isActive    Boolean  @default(true)
  position    Int      @default(0)
  startDate   DateTime?
  endDate     DateTime?
  clickCount  Int      @default(0)
}

model Review {
  id              Int      @id @default(autoincrement())
  userId          Int
  productId       Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating          Int
  comment         String?
  images          String[] 
  verifiedPurchase Boolean @default(false)
  helpfulCount    Int      @default(0)
  createdAt       DateTime @default(now())

  @@unique([userId, productId])
  @@index([productId, rating])
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  addedAt   DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

// --- VIRTUAL TRY-ON ---
model UserBodyProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit      String   @default("cm")
  height    Float
  weight    Float
  chest     Float
  waist     Float
  hip       Float
  updatedAt DateTime @updatedAt
}

model ProductMeasurement {
  id        Int            @id @default(autoincrement())
  variantId Int            @unique
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  unit      String         @default("cm")
  chest     Float?
  waist     Float?
  hip       Float?
  length    Float?
}

model AIModel {
  id          Int                   @id @default(autoincrement())
  name        String
  version     String
  description String?
  sessions    VirtualTryOnSession[]
}

model VirtualTryOnSession {
  id             Int            @id @default(autoincrement())
  userId         Int
  variantId      Int?
  aiModelId      Int?
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  aiModel        AIModel?        @relation(fields: [aiModelId], references: [id], onDelete: SetNull)
  inputImage     String
  outputImage    String
  status         String         @default("COMPLETED") 
  processingTime Int?           
  createdAt      DateTime       @default(now())

  @@index([userId, createdAt])
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  VNPAY
  COD
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}